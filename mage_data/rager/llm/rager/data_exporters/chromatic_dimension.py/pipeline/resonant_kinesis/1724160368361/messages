{"result_id": "881e1cb12a2546f69bf7673bfd2306fa", "data_type": "text/plain", "error": null, "metadata": null, "output": "Index name: documents_20240820_2612\n", "process": {"data": [], "exitcode": null, "is_alive": false, "internal_state": "INIT", "kernel_uuid": "chromatic_dimension", "message": "from typing import Dict, List, Union\nimport numpy as np\nfrom elasticsearch import Elasticsearch, exceptions\n\nif 'data_exporter' not in globals():\n    from mage_ai.data_preparation.decorators import data_exporter\n\n\n@data_exporter\ndef elasticsearch(\n    documents: List[Dict[str, Union[Dict, List[int], np.ndarray, str]]], *args, **kwargs,\n):\n    \"\"\"\n    Exports document data to an Elasticsearch database.\n    \"\"\"\n\n    connection_string = kwargs.get('connection_string', 'http://localhost:9200')\n    from datetime import datetime\n\n    index_name_prefix = kwargs.get('index_name', 'documents')\n    current_time = datetime.now().strftime(\"%Y%m%d_%M%S\")\n    index_name = f\"{index_name_prefix}_{current_time}\"\n    print(\"Index name:\", index_name)\n\n    number_of_shards = kwargs.get('number_of_shards', 1)\n    number_of_replicas = kwargs.get('number_of_replicas', 0)\n    vector_column_name = kwargs.get('vector_column_name', 'embedding')\n\n    from mage_ai.data_preparation.variable_manager import set_global_variable\n\n    set_global_variable('resonant_kinesis', 'index_name', index_name)\n\n    dimensions = kwargs.get('dimensions')\n    if dimensions is None and len(documents) > 0:\n        document = documents[0]\n        dimensions = len(document.get(vector_column_name) or [])\n\n    try:\n        es_client = Elasticsearch(connection_string)\n        print(f'Connecting to Elasticsearch at {connection_string}')\n    except exceptions.ConnectionError as e:\n        print(f\"Could not connect to Elasticsearch: {e}\")\n        return\n\n    # Define index settings with custom mappings\n    index_settings = {\n        \"settings\": {\n            \"number_of_shards\": number_of_shards,\n            \"number_of_replicas\": number_of_replicas\n        },\n        \"mappings\": {\n            \"properties\": {\n                \"text\": {\"type\": \"text\"},\n                \"section\": {\"type\": \"text\"},\n                \"question\": {\"type\": \"text\"},\n                \"course\": {\"type\": \"keyword\"},\n                \"document_id\": {\"type\": \"keyword\"},\n                vector_column_name: {\n                    \"type\": \"dense_vector\",\n                    \"dims\": dimensions\n                } if dimensions else {}\n            }\n        }\n    }\n\n    if not es_client.indices.exists(index=index_name):\n        es_client.indices.create(index=index_name, body=index_settings)\n        print(f'Index {index_name} created with settings:', index_settings)\n        print('Embedding dimensions:', dimensions)\n\n    print(f'Indexing {len(documents)} documents to Elasticsearch index {index_name}')\n    for document in documents:\n        print(f'Indexing document {document.get(\"document_id\")}')\n        es_client.index(index=index_name, document=document)\n        print(document)\n", "message_request_uuid": "1724160368361", "message_uuid": "7e30cb90d620482da0d0808b06835e09", "output_manager": {"namespace": "pipeline/resonant_kinesis", "path": "llm/rager/data_exporters/chromatic_dimension.py", "uuid": "1724160368361"}, "pid": "7e30cb90d620482da0d0808b06835e09", "pid_spawn": null, "source": "chromatic_dimension", "stream": "code_executions", "timestamp": null, "timestamp_end": null, "uuid": "chromatic_dimension"}, "status": "running", "type": "stdout", "uuid": "chromatic_dimension", "timestamp": 1724160372714, "output_text": "Index name: documents_20240820_2612\n"}
{"result_id": "2cea9b215b3e44988ec11a14900d770e", "data_type": "text/plain", "error": null, "metadata": null, "output": "Connecting to Elasticsearch at http://host.docker.internal:9200\n", "process": {"data": [], "exitcode": null, "is_alive": false, "internal_state": "INIT", "kernel_uuid": "chromatic_dimension", "message": "from typing import Dict, List, Union\nimport numpy as np\nfrom elasticsearch import Elasticsearch, exceptions\n\nif 'data_exporter' not in globals():\n    from mage_ai.data_preparation.decorators import data_exporter\n\n\n@data_exporter\ndef elasticsearch(\n    documents: List[Dict[str, Union[Dict, List[int], np.ndarray, str]]], *args, **kwargs,\n):\n    \"\"\"\n    Exports document data to an Elasticsearch database.\n    \"\"\"\n\n    connection_string = kwargs.get('connection_string', 'http://localhost:9200')\n    from datetime import datetime\n\n    index_name_prefix = kwargs.get('index_name', 'documents')\n    current_time = datetime.now().strftime(\"%Y%m%d_%M%S\")\n    index_name = f\"{index_name_prefix}_{current_time}\"\n    print(\"Index name:\", index_name)\n\n    number_of_shards = kwargs.get('number_of_shards', 1)\n    number_of_replicas = kwargs.get('number_of_replicas', 0)\n    vector_column_name = kwargs.get('vector_column_name', 'embedding')\n\n    from mage_ai.data_preparation.variable_manager import set_global_variable\n\n    set_global_variable('resonant_kinesis', 'index_name', index_name)\n\n    dimensions = kwargs.get('dimensions')\n    if dimensions is None and len(documents) > 0:\n        document = documents[0]\n        dimensions = len(document.get(vector_column_name) or [])\n\n    try:\n        es_client = Elasticsearch(connection_string)\n        print(f'Connecting to Elasticsearch at {connection_string}')\n    except exceptions.ConnectionError as e:\n        print(f\"Could not connect to Elasticsearch: {e}\")\n        return\n\n    # Define index settings with custom mappings\n    index_settings = {\n        \"settings\": {\n            \"number_of_shards\": number_of_shards,\n            \"number_of_replicas\": number_of_replicas\n        },\n        \"mappings\": {\n            \"properties\": {\n                \"text\": {\"type\": \"text\"},\n                \"section\": {\"type\": \"text\"},\n                \"question\": {\"type\": \"text\"},\n                \"course\": {\"type\": \"keyword\"},\n                \"document_id\": {\"type\": \"keyword\"},\n                vector_column_name: {\n                    \"type\": \"dense_vector\",\n                    \"dims\": dimensions\n                } if dimensions else {}\n            }\n        }\n    }\n\n    if not es_client.indices.exists(index=index_name):\n        es_client.indices.create(index=index_name, body=index_settings)\n        print(f'Index {index_name} created with settings:', index_settings)\n        print('Embedding dimensions:', dimensions)\n\n    print(f'Indexing {len(documents)} documents to Elasticsearch index {index_name}')\n    for document in documents:\n        print(f'Indexing document {document.get(\"document_id\")}')\n        es_client.index(index=index_name, document=document)\n        print(document)\n", "message_request_uuid": "1724160368361", "message_uuid": "7e30cb90d620482da0d0808b06835e09", "output_manager": {"namespace": "pipeline/resonant_kinesis", "path": "llm/rager/data_exporters/chromatic_dimension.py", "uuid": "1724160368361"}, "pid": "7e30cb90d620482da0d0808b06835e09", "pid_spawn": null, "source": "chromatic_dimension", "stream": "code_executions", "timestamp": null, "timestamp_end": null, "uuid": "chromatic_dimension"}, "status": "running", "type": "stdout", "uuid": "chromatic_dimension", "timestamp": 1724160372775, "output_text": "Connecting to Elasticsearch at http://host.docker.internal:9200\n"}
{"result_id": "a34454e6aade4c5d87789492a73ea477", "data_type": null, "error": {"code": "from typing import Dict, List, Union\nimport numpy as np\nfrom elasticsearch import Elasticsearch, exceptions\n\nif 'data_exporter' not in globals():\n    from mage_ai.data_preparation.decorators import data_exporter\n\n\n@data_exporter\ndef elasticsearch(\n    documents: List[Dict[str, Union[Dict, List[int], np.ndarray, str]]], *args, **kwargs,\n):\n    \"\"\"\n    Exports document data to an Elasticsearch database.\n    \"\"\"\n\n    connection_string = kwargs.get('connection_string', 'http://localhost:9200')\n    from datetime import datetime\n\n    index_name_prefix = kwargs.get('index_name', 'documents')\n    current_time = datetime.now().strftime(\"%Y%m%d_%M%S\")\n    index_name = f\"{index_name_prefix}_{current_time}\"\n    print(\"Index name:\", index_name)\n\n    number_of_shards = kwargs.get('number_of_shards', 1)\n    number_of_replicas = kwargs.get('number_of_replicas', 0)\n    vector_column_name = kwargs.get('vector_column_name', 'embedding')\n\n    from mage_ai.data_preparation.variable_manager import set_global_variable\n\n    set_global_variable('resonant_kinesis', 'index_name', index_name)\n\n    dimensions = kwargs.get('dimensions')\n    if dimensions is None and len(documents) > 0:\n        document = documents[0]\n        dimensions = len(document.get(vector_column_name) or [])\n\n    try:\n        es_client = Elasticsearch(connection_string)\n        print(f'Connecting to Elasticsearch at {connection_string}')\n    except exceptions.ConnectionError as e:\n        print(f\"Could not connect to Elasticsearch: {e}\")\n        return\n\n    # Define index settings with custom mappings\n    index_settings = {\n        \"settings\": {\n            \"number_of_shards\": number_of_shards,\n            \"number_of_replicas\": number_of_replicas\n        },\n        \"mappings\": {\n            \"properties\": {\n                \"text\": {\"type\": \"text\"},\n                \"section\": {\"type\": \"text\"},\n                \"question\": {\"type\": \"text\"},\n                \"course\": {\"type\": \"keyword\"},\n                \"document_id\": {\"type\": \"keyword\"},\n                vector_column_name: {\n                    \"type\": \"dense_vector\",\n                    \"dims\": dimensions\n                } if dimensions else {}\n            }\n        }\n    }\n\n    if not es_client.indices.exists(index=index_name):\n        es_client.indices.create(index=index_name, body=index_settings)\n        print(f'Index {index_name} created with settings:', index_settings)\n        print('Embedding dimensions:', dimensions)\n\n    print(f'Indexing {len(documents)} documents to Elasticsearch index {index_name}')\n    for document in documents:\n        print(f'Indexing document {document.get(\"document_id\")}')\n        es_client.index(index=index_name, document=document)\n        print(document)\n", "code_context": [], "code_context_formatted": [], "error": "Connection error caused by: ConnectionError(Connection error caused by: NewConnectionError(<urllib3.connection.HTTPConnection object at 0x77ba56cc2170>: Failed to establish a new connection: [Errno -2] Name or service not known))", "errors": null, "exception": "ConnectionError: Connection error caused by: ConnectionError(Connection error caused by: NewConnectionError(<urllib3.connection.HTTPConnection object at 0x77ba56cc2170>: Failed to establish a new connection: [Errno -2] Name or service not known))", "line_number": 202, "message": "Connection error caused by: ConnectionError(Connection error caused by: NewConnectionError(<urllib3.connection.HTTPConnection object at 0x77ba56cc2170>: Failed to establish a new connection: [Errno -2] Name or service not known))", "message_formatted": "Connection error caused by: ConnectionError(Connection error caused by: NewConnectionError(<urllib3.connection.HTTPConnection object at 0x77ba56cc2170>: Failed to establish a new connection: [Errno -2] Name or service not known))", "stacktrace": ["Traceback (most recent call last):\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/execution.py\", line 281, in execute_code_async\n    local_variables = await __modify_and_execute(\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/execution.py\", line 135, in __modify_and_execute\n    raise error\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/execution.py\", line 117, in __modify_and_execute\n    res = await res\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/environments/setup_helpers.py\", line 48, in execute\n    await block.execute(\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\", line 1711, in execute\n    await loop.run_in_executor(\n", "  File \"/usr/local/lib/python3.10/concurrent/futures/thread.py\", line 58, in run\n    result = self.fn(*self.args, **self.kwargs)\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\", line 1688, in execute_sync\n    return __execute()\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\", line 1665, in __execute\n    raise err\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\", line 1567, in __execute\n    output = self.execute_block(\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\", line 1912, in execute_block\n    outputs = self._execute_block(\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\", line 2075, in _execute_block\n    outputs = self.execute_block_function(\n", "  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\", line 2186, in execute_block_function\n    output = block_function_updated(*input_vars, **runtime_variables)\n", "  File \"<string>\", line 67, in elasticsearch\n", "  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/utils.py\", line 414, in wrapped\n    return api(*args, **kwargs)\n", "  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/indices.py\", line 1180, in exists\n    return self.perform_request(  # type: ignore[return-value]\n", "  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/_base.py\", line 389, in perform_request\n    return self._client.perform_request(\n", "  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/_base.py\", line 285, in perform_request\n    meta, resp_body = self.transport.perform_request(\n", "  File \"/usr/local/lib/python3.10/site-packages/elastic_transport/_transport.py\", line 342, in perform_request\n    resp = node.perform_request(\n", "  File \"/usr/local/lib/python3.10/site-packages/elastic_transport/_node/_http_urllib3.py\", line 202, in perform_request\n    raise err from None\n", "elastic_transport.ConnectionError: Connection error caused by: ConnectionError(Connection error caused by: NewConnectionError(<urllib3.connection.HTTPConnection object at 0x77ba56cc2170>: Failed to establish a new connection: [Errno -2] Name or service not known))\n"], "stacktrace_formatted": ["\u001b[91mTraceback (most recent call last):\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/execution.py\"\u001b[0m, \u001b[36mline 281\u001b[0m, \u001b[35min execute_code_async\n    local_variables = await __modify_and_execute(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/execution.py\"\u001b[0m, \u001b[36mline 135\u001b[0m, \u001b[35min __modify_and_execute\n    raise error\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/execution.py\"\u001b[0m, \u001b[36mline 117\u001b[0m, \u001b[35min __modify_and_execute\n    res = await res\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/kernels/magic/environments/setup_helpers.py\"\u001b[0m, \u001b[36mline 48\u001b[0m, \u001b[35min execute\n    await block.execute(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\"\u001b[0m, \u001b[36mline 1711\u001b[0m, \u001b[35min execute\n    await loop.run_in_executor(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/concurrent/futures/thread.py\"\u001b[0m, \u001b[36mline 58\u001b[0m, \u001b[35min run\n    result = self.fn(*self.args, **self.kwargs)\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\"\u001b[0m, \u001b[36mline 1688\u001b[0m, \u001b[35min execute_sync\n    return __execute()\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\"\u001b[0m, \u001b[36mline 1665\u001b[0m, \u001b[35min __execute\n    raise err\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\"\u001b[0m, \u001b[36mline 1567\u001b[0m, \u001b[35min __execute\n    output = self.execute_block(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\"\u001b[0m, \u001b[36mline 1912\u001b[0m, \u001b[35min execute_block\n    outputs = self._execute_block(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\"\u001b[0m, \u001b[36mline 2075\u001b[0m, \u001b[35min _execute_block\n    outputs = self.execute_block_function(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/mage_ai/data_preparation/models/block/__init__.py\"\u001b[0m, \u001b[36mline 2186\u001b[0m, \u001b[35min execute_block_function\n    output = block_function_updated(*input_vars, **runtime_variables)\n\u001b[0m", "\u001b[34m  File \"<string>\"\u001b[0m, \u001b[36mline 67\u001b[0m, \u001b[35min elasticsearch\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/utils.py\"\u001b[0m, \u001b[36mline 414\u001b[0m, \u001b[35min wrapped\n    return api(*args, **kwargs)\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/indices.py\"\u001b[0m, \u001b[36mline 1180\u001b[0m, \u001b[35min exists\n    return self.perform_request(  # type: ignore[return-value]\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/_base.py\"\u001b[0m, \u001b[36mline 389\u001b[0m, \u001b[35min perform_request\n    return self._client.perform_request(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/elasticsearch/_sync/client/_base.py\"\u001b[0m, \u001b[36mline 285\u001b[0m, \u001b[35min perform_request\n    meta, resp_body = self.transport.perform_request(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/elastic_transport/_transport.py\"\u001b[0m, \u001b[36mline 342\u001b[0m, \u001b[35min perform_request\n    resp = node.perform_request(\n\u001b[0m", "\u001b[34m  File \"/usr/local/lib/python3.10/site-packages/elastic_transport/_node/_http_urllib3.py\"\u001b[0m, \u001b[36mline 202\u001b[0m, \u001b[35min perform_request\n    raise err from None\n\u001b[0m", "\u001b[90melastic_transport.ConnectionError: Connection error caused by: ConnectionError(Connection error caused by: NewConnectionError(<urllib3.connection.HTTPConnection object at 0x77ba56cc2170>: Failed to establish a new connection: [Errno -2] Name or service not known))\n\u001b[0m", "\u001b[91mConnection error caused by: ConnectionError(Connection error caused by: NewConnectionError(<urllib3.connection.HTTPConnection object at 0x77ba56cc2170>: Failed to establish a new connection: [Errno -2] Name or service not known))\u001b[0m"], "type": "ConnectionError"}, "metadata": null, "output": null, "process": {"data": [], "exitcode": null, "is_alive": false, "internal_state": "INIT", "kernel_uuid": "chromatic_dimension", "message": "from typing import Dict, List, Union\nimport numpy as np\nfrom elasticsearch import Elasticsearch, exceptions\n\nif 'data_exporter' not in globals():\n    from mage_ai.data_preparation.decorators import data_exporter\n\n\n@data_exporter\ndef elasticsearch(\n    documents: List[Dict[str, Union[Dict, List[int], np.ndarray, str]]], *args, **kwargs,\n):\n    \"\"\"\n    Exports document data to an Elasticsearch database.\n    \"\"\"\n\n    connection_string = kwargs.get('connection_string', 'http://localhost:9200')\n    from datetime import datetime\n\n    index_name_prefix = kwargs.get('index_name', 'documents')\n    current_time = datetime.now().strftime(\"%Y%m%d_%M%S\")\n    index_name = f\"{index_name_prefix}_{current_time}\"\n    print(\"Index name:\", index_name)\n\n    number_of_shards = kwargs.get('number_of_shards', 1)\n    number_of_replicas = kwargs.get('number_of_replicas', 0)\n    vector_column_name = kwargs.get('vector_column_name', 'embedding')\n\n    from mage_ai.data_preparation.variable_manager import set_global_variable\n\n    set_global_variable('resonant_kinesis', 'index_name', index_name)\n\n    dimensions = kwargs.get('dimensions')\n    if dimensions is None and len(documents) > 0:\n        document = documents[0]\n        dimensions = len(document.get(vector_column_name) or [])\n\n    try:\n        es_client = Elasticsearch(connection_string)\n        print(f'Connecting to Elasticsearch at {connection_string}')\n    except exceptions.ConnectionError as e:\n        print(f\"Could not connect to Elasticsearch: {e}\")\n        return\n\n    # Define index settings with custom mappings\n    index_settings = {\n        \"settings\": {\n            \"number_of_shards\": number_of_shards,\n            \"number_of_replicas\": number_of_replicas\n        },\n        \"mappings\": {\n            \"properties\": {\n                \"text\": {\"type\": \"text\"},\n                \"section\": {\"type\": \"text\"},\n                \"question\": {\"type\": \"text\"},\n                \"course\": {\"type\": \"keyword\"},\n                \"document_id\": {\"type\": \"keyword\"},\n                vector_column_name: {\n                    \"type\": \"dense_vector\",\n                    \"dims\": dimensions\n                } if dimensions else {}\n            }\n        }\n    }\n\n    if not es_client.indices.exists(index=index_name):\n        es_client.indices.create(index=index_name, body=index_settings)\n        print(f'Index {index_name} created with settings:', index_settings)\n        print('Embedding dimensions:', dimensions)\n\n    print(f'Indexing {len(documents)} documents to Elasticsearch index {index_name}')\n    for document in documents:\n        print(f'Indexing document {document.get(\"document_id\")}')\n        es_client.index(index=index_name, document=document)\n        print(document)\n", "message_request_uuid": "1724160368361", "message_uuid": "7e30cb90d620482da0d0808b06835e09", "output_manager": {"namespace": "pipeline/resonant_kinesis", "path": "llm/rager/data_exporters/chromatic_dimension.py", "uuid": "1724160368361"}, "pid": "7e30cb90d620482da0d0808b06835e09", "pid_spawn": null, "source": "chromatic_dimension", "stream": "code_executions", "timestamp": null, "timestamp_end": null, "uuid": "chromatic_dimension"}, "status": "error", "type": "status", "uuid": "chromatic_dimension", "timestamp": 1724160372787, "output_text": null}
{"result_id": "d06fb13ad41b47d4a984d9c8d37ee0d7", "data_type": null, "error": null, "metadata": {"namespace": "pipeline/resonant_kinesis", "path": "llm/rager/data_exporters/chromatic_dimension.py", "uuid": "1724160368361", "block_type": "data_exporter", "block_uuid": "chromatic_dimension", "execution_partition": null, "pipeline_uuid": "resonant_kinesis"}, "output": "", "process": {"data": [], "exitcode": null, "is_alive": false, "internal_state": "INIT", "kernel_uuid": "chromatic_dimension", "message": "from typing import Dict, List, Union\nimport numpy as np\nfrom elasticsearch import Elasticsearch, exceptions\n\nif 'data_exporter' not in globals():\n    from mage_ai.data_preparation.decorators import data_exporter\n\n\n@data_exporter\ndef elasticsearch(\n    documents: List[Dict[str, Union[Dict, List[int], np.ndarray, str]]], *args, **kwargs,\n):\n    \"\"\"\n    Exports document data to an Elasticsearch database.\n    \"\"\"\n\n    connection_string = kwargs.get('connection_string', 'http://localhost:9200')\n    from datetime import datetime\n\n    index_name_prefix = kwargs.get('index_name', 'documents')\n    current_time = datetime.now().strftime(\"%Y%m%d_%M%S\")\n    index_name = f\"{index_name_prefix}_{current_time}\"\n    print(\"Index name:\", index_name)\n\n    number_of_shards = kwargs.get('number_of_shards', 1)\n    number_of_replicas = kwargs.get('number_of_replicas', 0)\n    vector_column_name = kwargs.get('vector_column_name', 'embedding')\n\n    from mage_ai.data_preparation.variable_manager import set_global_variable\n\n    set_global_variable('resonant_kinesis', 'index_name', index_name)\n\n    dimensions = kwargs.get('dimensions')\n    if dimensions is None and len(documents) > 0:\n        document = documents[0]\n        dimensions = len(document.get(vector_column_name) or [])\n\n    try:\n        es_client = Elasticsearch(connection_string)\n        print(f'Connecting to Elasticsearch at {connection_string}')\n    except exceptions.ConnectionError as e:\n        print(f\"Could not connect to Elasticsearch: {e}\")\n        return\n\n    # Define index settings with custom mappings\n    index_settings = {\n        \"settings\": {\n            \"number_of_shards\": number_of_shards,\n            \"number_of_replicas\": number_of_replicas\n        },\n        \"mappings\": {\n            \"properties\": {\n                \"text\": {\"type\": \"text\"},\n                \"section\": {\"type\": \"text\"},\n                \"question\": {\"type\": \"text\"},\n                \"course\": {\"type\": \"keyword\"},\n                \"document_id\": {\"type\": \"keyword\"},\n                vector_column_name: {\n                    \"type\": \"dense_vector\",\n                    \"dims\": dimensions\n                } if dimensions else {}\n            }\n        }\n    }\n\n    if not es_client.indices.exists(index=index_name):\n        es_client.indices.create(index=index_name, body=index_settings)\n        print(f'Index {index_name} created with settings:', index_settings)\n        print('Embedding dimensions:', dimensions)\n\n    print(f'Indexing {len(documents)} documents to Elasticsearch index {index_name}')\n    for document in documents:\n        print(f'Indexing document {document.get(\"document_id\")}')\n        es_client.index(index=index_name, document=document)\n        print(document)\n", "message_request_uuid": "1724160368361", "message_uuid": "7e30cb90d620482da0d0808b06835e09", "output_manager": {"namespace": "pipeline/resonant_kinesis", "path": "llm/rager/data_exporters/chromatic_dimension.py", "uuid": "1724160368361"}, "pid": "7e30cb90d620482da0d0808b06835e09", "pid_spawn": null, "source": "chromatic_dimension", "stream": "code_executions", "timestamp": null, "timestamp_end": null, "uuid": "chromatic_dimension"}, "status": "success", "type": "output", "uuid": "chromatic_dimension", "timestamp": 1724160372834, "output_text": ""}
